<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shorten</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #f9fafb; }
        .card { background-color: #1f2937; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3); }
        .input-field { background-color: #374151; color: #f9fafb; border: 1px solid #4b5563; padding: 0.6rem; border-radius: 0.5rem; }
        .input-field:focus { border-color: #10a0e9; ring: 2px; ring-color: #10a0e9; }
        .blue-btn { background-color: #10a0e9; color: white; transition: background-color 0.15s; }
        .blue-btn:hover { background-color: #0d8cc0; }
        .section-heading { color: #d1d5db; border-bottom: 1px solid #374151; padding-bottom: 0.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto space-y-8">
        <header class="text-center py-6 card">
            <h1 class="text-4xl font-extrabold text-[#10a0e9]">URL SHORTEN SERVICE</h1>
            <p class="text-gray-400 mt-2">Enterprise-grade URL Shortening.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                    <h2 class="text-2xl font-semibold section-heading">Generate Link</h2>
                    <form id="shorten-form" onsubmit="handleShorten(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Original URL</label>
                            <input type="url" id="original-url" required placeholder="https://example.com/long-url" class="w-full input-field">
                        </div>
                        
                        <div class="border border-gray-600 p-3 rounded-lg">
                            <h3 class="text-md font-semibold text-gray-300 mb-2">Expiration Time (Leave empty or 0 for permanent)</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Days</label>
                                    <input type="number" id="days-valid" min="0" value="0" placeholder="0" class="w-full input-field">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Hours</label>
                                    <input type="number" id="hours-valid" min="0" value="0" placeholder="0" class="w-full input-field">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Seconds</label>
                                    <input type="number" id="seconds-valid" min="0" value="0" placeholder="0" class="w-full input-field">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Custom Code</label>
                                <input type="text" id="custom-code" placeholder="Optional (my-code)" class="w-full input-field">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Custom Domain</label>
                                <input type="text" id="custom-domain" placeholder="Optional (https://my.link)" class="w-full input-field">
                            </div>
                        </div>
                        <button type="submit" class="w-full py-2.5 mt-2 rounded-lg font-medium blue-btn shadow-lg">Shorten URL</button>
                    </form>
                    <div id="shorten-result" class="mt-4 p-3 rounded-lg hidden text-sm font-medium"></div>
                </div>

                <div class="card p-6">
                    <h2 class="text-2xl font-semibold section-heading">Bulk Shortening</h2>
                    <form id="bulk-form" onsubmit="handleBulkShorten(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Paste CSV Data</label>
                            <textarea id="csv-data" rows="4" placeholder="CSV format: URL, Days, Hours, Seconds, CustomCode, CustomDomain&#10;https://example.com/url1, 30, 0, 0, link1, &#10;https://example.com/url2, 0, 2, 30, , https://brnd.ly" class="w-full input-field"></textarea>
                        </div>
                        <button type="submit" class="w-full py-2.5 rounded-lg font-medium bg-gray-600 text-white hover:bg-gray-700 shadow-lg transition">Process Bulk CSV</button>
                    </form>
                    <div id="bulk-result" class="mt-4 max-h-48 overflow-y-auto space-y-1"></div>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                
                <div class="card p-4">
                    <h2 class="text-xl font-semibold section-heading">Dashboard Warnings</h2>
                    <div id="dashboard-warnings" class="text-sm space-y-2">
                        <p class="text-gray-400">Loading...</p>
                    </div>
                </div>

                <div class="card p-4">
                    <h2 class="text-xl font-semibold section-heading">Link Analytics</h2>
                    <div>
                        <label class="block text-sm font-medium mb-1">Enter Short Code</label>
                        <div class="flex space-x-2">
                            <input type="text" id="analytics-code" placeholder="e.g., z8x4g3h" class="w-full input-field">
                            <button onclick="handleAnalytics()" class="py-2 px-3 rounded-lg font-medium bg-green-600 text-white hover:bg-green-700 transition">View</button>
                        </div>
                    </div>
                    <div id="analytics-display" class="bg-gray-700 p-3 rounded-lg text-sm mt-3 max-h-60 overflow-y-auto">
                        <p class="text-gray-400">Enter a short code to view tracking data.</p>
                    </div>
                </div>

                <div class="card p-4 text-center">
                    <h2 class="text-xl font-semibold section-heading">QR Code</h2>
                    <div id="qr-code-display" class="w-40 h-40 mx-auto bg-white border-4 border-gray-600 rounded-lg flex items-center justify-center text-xs text-gray-700">
                        </div>
                    <p class="text-gray-400 mt-2 text-sm" id="qr-code-link">No link selected.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const BASE_API_URL = '/api/';
        // Jinja2 will replace this variable
        const BASE_URL = '{{ shortener.default_base_url }}';

        // --- Utility Functions ---

        function copyToClipboard(text, buttonId) {
            // Using document.execCommand('copy') for better iframe compatibility
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; 
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                const button = document.getElementById(buttonId);
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => button.textContent = originalText, 1000);
            } catch (err) {
                console.error('Could not copy text: ', err);
            } finally {
                document.body.removeChild(textarea);
            }
        }

        function generateQRCode(text) {
            const qrDiv = document.getElementById('qr-code-display');
            qrDiv.innerHTML = '';
            
            // Generate QR code using qrcode.js
            new QRCode(qrDiv, {
                text: text,
                width: 150,
                height: 150,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            document.getElementById('qr-code-link').textContent = text.replace(BASE_URL, 'http://short.ly/');
        }

        // --- Feature Handlers ---

        async function handleShorten(event) {
            event.preventDefault();
            const originalUrl = document.getElementById('original-url').value;
            
            // Collect expiration fields
            const daysValid = document.getElementById('days-valid').value ? parseInt(document.getElementById('days-valid').value) : null;
            const hoursValid = document.getElementById('hours-valid').value ? parseInt(document.getElementById('hours-valid').value) : null;
            const secondsValid = document.getElementById('seconds-valid').value ? parseInt(document.getElementById('seconds-valid').value) : null;
            
            const customCode = document.getElementById('custom-code').value.trim() || null;
            const customDomain = document.getElementById('custom-domain').value.trim() || null;
            const resultDiv = document.getElementById('shorten-result');
            
            resultDiv.className = 'mt-4 p-3 rounded-lg text-sm font-medium';
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = 'Processing...';

            const payload = { 
                original_url: originalUrl, 
                days_valid: daysValid, 
                hours_valid: hoursValid,
                seconds_valid: secondsValid,
                custom_code: customCode, 
                custom_domain: customDomain 
            };

            try {
                const response = await fetch(BASE_API_URL + 'shorten', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    resultDiv.classList.add('bg-green-800', 'text-green-100');
                    const shortLink = result.shortLink;
                    const shortCode = result.shortCode;
                    
                    resultDiv.innerHTML = `
                        <strong>Success!</strong> Short Link: 
                        <a href="${shortLink}" target="_blank" class="text-blue-300 hover:underline font-semibold">${shortLink}</a>
                        <button id="copy-btn-${shortCode}" class="ml-3 text-xs py-1 px-2 rounded blue-btn" onclick="copyToClipboard('${shortLink}', 'copy-btn-${shortCode}')">Copy</button>
                    `;
                    document.getElementById('analytics-code').value = shortCode;
                    handleAnalytics(); // Auto-show analytics
                    generateQRCode(shortLink);
                    fetchDashboardData(); // Update dashboard
                } else {
                    resultDiv.classList.add('bg-red-800', 'text-red-100');
                    resultDiv.innerHTML = `<strong>Error:</strong> ${result.error || 'Unknown error.'}`;
                }
            } catch (error) {
                resultDiv.classList.add('bg-red-800', 'text-red-100');
                resultDiv.innerHTML = `<strong>Network Error:</strong> Could not reach the server.`;
            }
        }

        async function handleAnalytics() {
            const shortCode = document.getElementById('analytics-code').value.trim();
            const displayDiv = document.getElementById('analytics-display');
            displayDiv.innerHTML = '<p class="text-gray-400">Loading analytics...</p>';

            if (!shortCode) {
                displayDiv.innerHTML = '<p class="text-red-500">Please enter a short code.</p>';
                return;
            }

            try {
                const response = await fetch(BASE_API_URL + 'analytics/' + shortCode);
                
                if (response.ok) {
                    const result = await response.json();
                    const info = result.url_info;
                    const summary = result.analytics_summary;
                    
                    displayDiv.innerHTML = `
                        <h3 class="font-bold text-lg text-[#10a0e9] border-b border-gray-600 mb-2">${info.short_link.replace(BASE_URL, 'http://short.ly/')}</h3>
                        <p class="text-xs text-gray-400 mb-3">Original: ${info.original_url.substring(0, 50)}...</p>
                        <p class="font-semibold text-white mb-2">Total Clicks: <span class="text-2xl">${summary.total_clicks}</span></p>
                        
                        <h4 class="font-medium mt-4 border-t border-gray-600 pt-2">Last 5 Clicks:</h4>
                        ${summary.last_5_clicks.reverse().map(click => 
                            `<div class="text-xs bg-gray-700 p-1 rounded-sm border-b border-gray-600 mb-0.5 text-gray-300">
                                ${new Date(click.timestamp).toLocaleString()}
                            </div>`
                        ).join('') || '<p class="text-xs text-gray-500">No recent clicks recorded.</p>'}
                    `;
                    generateQRCode(info.short_link);

                } else {
                    const result = await response.json();
                    let error_message = result.error || 'Link not found or server error.';
                    if (response.status === 404) {
                        error_message = `Error 404: Link '${shortCode}' not found. Check the code or if it expired.`;
                    }
                    displayDiv.innerHTML = `<p class="text-red-500">Error: ${error_message}</p>`;
                    
                    document.getElementById('qr-code-display').innerHTML = '<p class="text-gray-500">Invalid link</p>';
                    document.getElementById('qr-code-link').textContent = 'No link selected.';
                }
            } catch (error) {
                console.error('Fetch/Parsing Error:', error);
                displayDiv.innerHTML = '<p class="text-red-500">Network Error: Failed to fetch analytics or parse response.</p>';
            }
        }

        async function fetchDashboardData() {
            const warningsDiv = document.getElementById('dashboard-warnings');
            warningsDiv.innerHTML = '<p class="text-gray-400">Refreshing data...</p>';
            
            try {
                const response = await fetch(BASE_API_URL + 'dashboard');
                const data = await response.json();
                
                let warningsHtml = '';
                if (data.warnings.length > 0) {
                    warningsHtml = data.warnings.map(w => {
                        const shortLinkDisplay = w.short_link.replace(BASE_URL, 'http://short.ly/');
                        
                        let timeRemainingText;
                        if (w.expires_in_days > 0) {
                            timeRemainingText = `<span class="font-bold">${w.expires_in_days} days.</span>`;
                        } else {
                            const totalSeconds = w.expires_in_seconds;
                            const hours = Math.floor(totalSeconds / 3600);
                            const minutes = Math.floor((totalSeconds % 3600) / 60);
                            
                            if (hours > 0 || minutes > 0) {
                                timeRemainingText = `<span class="font-bold">${hours}h ${minutes}m</span>.`;
                            } else {
                                timeRemainingText = `<span class="font-bold">${totalSeconds}s</span>.`;
                            }
                        }
                        
                        return `
                            <div class="p-2 bg-yellow-900 rounded-lg text-yellow-200 text-xs">
                                <span class="font-semibold">${shortLinkDisplay}</span> expires in 
                                ${timeRemainingText}
                            </div>
                        `;
                    }).join('');
                } else {
                    warningsHtml = '<p class="text-green-500 font-medium">No links expiring soon.</p>';
                }
                
                warningsDiv.innerHTML = warningsHtml;
                
            } catch (error) {
                warningsDiv.innerHTML = '<p class="text-red-500">Error fetching dashboard data.</p>';
            }
        }

        async function handleBulkShorten(event) {
            event.preventDefault();
            const csvData = document.getElementById('csv-data').value;
            const resultDiv = document.getElementById('bulk-result');
            resultDiv.innerHTML = '<p class="text-gray-400">Processing bulk request...</p>';

            if (!csvData.trim()) {
                resultDiv.innerHTML = '<p class="text-red-500">Please paste CSV data.</p>';
                return;
            }

            try {
                const response = await fetch(BASE_API_URL + 'bulk-shorten', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ csv_data: csvData })
                });

                const data = await response.json();
                
                let html = '<h4 class="font-medium text-lg mb-2 text-white">Bulk Results:</h4>';
                
                data.results.forEach(res => {
                    const statusClass = res.status === 'Success' ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200';
                    const linkText = res.status === 'Success' ? res.short_link.replace(BASE_URL, 'http://short.ly/') : res.url.substring(0, 30) + '...';
                    const message = res.status === 'Success' ? 'OK' : `FAIL: ${res.error}`;

                    html += `
                        <div class="p-2 text-sm rounded-lg ${statusClass}">
                            <span class="font-semibold">${message}:</span> ${linkText}
                        </div>
                    `;
                });
                resultDiv.innerHTML = html;
                fetchDashboardData(); 
            } catch (error) {
                resultDiv.innerHTML = '<p class="text-red-500">Network Error: Failed to process bulk links.</p>';
            }
        }

        // Initial Load
        window.onload = () => {
             fetchDashboardData();
        }
    </script>
</body>
</html>